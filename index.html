<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurix - Your Personal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markmap-lib/0.15.0/markmap-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markmap-view/0.15.0/markmap-view.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-main: #f0f2f5;
            --bg-chat-window: #ffffff;
            --text-primary: #333;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --bubble-user-bg: #007bff;
            --bubble-user-text: #ffffff;
            --bubble-ai-bg: #e9e9eb;
            --bubble-ai-text: #333;
            --input-bg: #f3f4f6;
        }

        body.dark-mode {
            --bg-main: #111827;
            --bg-chat-window: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --bubble-user-bg: #3b82f6;
            --bubble-user-text: #ffffff;
            --bubble-ai-bg: #4b5563;
            --bubble-ai-text: #f9fafb;
            --input-bg: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        .chat-window {
            background-color: var(--bg-chat-window);
        }
        .chat-border {
            border-color: var(--border-color);
        }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .input-bg { background-color: var(--input-bg); }

        .admin-gradient {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
        }
        .chat-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: var(--bubble-user-bg);
            color: var(--bubble-user-text);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .chat-bubble-ai {
            background-color: var(--bubble-ai-bg);
            color: var(--bubble-ai-text);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .hidden {
            display: none;
        }
        #admin-panel, #login-modal, #preview-modal, #mindmap-modal, #settings-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #main-title {
            cursor: pointer;
        }
        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            margin: 8px 0;
            max-width: 90%;
            align-self: flex-start;
            width: 100%;
        }
        .code-header {
            background-color: #334155;
            padding: 8px 16px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .code-body {
            padding: 16px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
        }
        #file-preview-container {
            position: relative;
            max-width: 200px;
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #remove-file-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        #study-mode-controls button {
            transition: all 0.2s ease-in-out;
        }
        #study-mode-controls button:hover {
            transform: translateY(-2px);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main User Chat Interface -->
    <div id="user-chat-interface" class="w-full h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-2xl h-full flex flex-col chat-window rounded-2xl shadow-2xl">
            <div class="p-4 border-b chat-border flex justify-between items-center">
                <h1 id="main-title" class="text-2xl font-bold text-center text-primary select-none">Aurix</h1>
                <div>
                     <button id="new-chat-btn" class="text-secondary hover:text-blue-600 p-2" title="New Chat">
                        <i class="fas fa-plus-circle text-xl"></i>
                    </button>
                     <button id="mindmap-btn" class="text-secondary hover:text-blue-600 p-2" title="Generate Mind Map">
                        <i class="fas fa-project-diagram text-xl"></i>
                    </button>
                    <button id="study-mode-toggle" class="text-secondary hover:text-blue-600 p-2" title="Study Mode">
                        <i class="fas fa-graduation-cap text-xl"></i>
                    </button>
                     <button id="settings-btn" class="text-secondary hover:text-blue-600 p-2" title="Settings">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="chat-box" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4">
                <!-- Chat messages will be appended here -->
                <div class="chat-bubble chat-bubble-ai">Hello! I am Aurix. You can now use the microphone to talk to me. Just say "send" when you're done.</div>
            </div>
            <div class="p-4 border-t chat-border">
                <div id="study-mode-controls" class="hidden flex justify-center gap-4 mb-2">
                    <button id="summarize-btn" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-600"><i class="fas fa-align-left mr-2"></i>Summarize</button>
                    <button id="test-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-600"><i class="fas fa-question-circle mr-2"></i>Create Test</button>
                </div>
                <div id="file-preview-container" class="hidden mb-2">
                    <div id="file-preview-content">
                        <!-- Preview for image or file icon -->
                    </div>
                    <button id="remove-file-btn">&times;</button>
                </div>
                <div class="flex items-center gap-4">
                    <button id="mic-btn" class="cursor-pointer text-secondary hover:text-blue-600 p-2">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="image/png, image/jpeg, image/webp, application/pdf, text/html">
                    <label for="file-input" class="cursor-pointer text-secondary hover:text-blue-600 p-2">
                        <i class="fas fa-paperclip text-xl"></i>
                    </label>
                    <input type="text" id="user-input" class="flex-1 w-full px-4 py-2 input-bg rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type or speak your message...">
                    <button id="send-btn" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold mb-2 text-gray-800">Admin Panel Access</h2>
            <p class="text-gray-500 mb-6">Enter your credentials to manage Aurix.</p>
            <div id="login-error" class="bg-red-100 text-red-700 p-3 rounded-lg mb-4 hidden">Invalid credentials. Please try again.</div>
            <form id="login-form">
                <div class="mb-4 text-left">
                    <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <div class="w-64 admin-gradient text-white flex flex-col">
                <div class="p-6 text-center border-b border-white/20">
                    <h2 class="text-2xl font-bold">Aurix Admin</h2>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#dashboard" class="admin-nav-link active flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/20 transition-colors" data-target="dashboard-section"><i class="fas fa-tachometer-alt w-5"></i> Dashboard</a>
                    <a href="#unanswered" class="admin-nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/20 transition-colors" data-target="unanswered-section"><i class="fas fa-question-circle w-5"></i> Unanswered</a>
                    <a href="#chats" class="admin-nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/20 transition-colors" data-target="chats-section"><i class="fas fa-comments w-5"></i> Chats</a>
                    <a href="#magic-lab" class="admin-nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/20 transition-colors" data-target="magic-lab-section"><i class="fas fa-flask w-5"></i> Magic Lab</a>
                </nav>
                <div class="p-4 border-t border-white/20">
                    <button id="logout-btn" class="w-full flex items-center justify-center gap-3 px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="admin-section">
                    <h1 class="text-4xl font-bold text-gray-800 mb-6">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-brain text-4xl text-blue-500"></i>
                            <div>
                                <p class="text-gray-500">Trained Pairs</p>
                                <p id="trained-count" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-question-circle text-4xl text-yellow-500"></i>
                            <div>
                                <p class="text-gray-500">Unanswered</p>
                                <p id="unanswered-count" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-comments text-4xl text-purple-500"></i>
                            <div>
                                <p class="text-gray-500">Total Chats</p>
                                <p id="chat-count" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unanswered Questions Section -->
                <div id="unanswered-section" class="admin-section hidden">
                    <h1 class="text-4xl font-bold text-gray-800 mb-6">Unanswered Questions</h1>
                    <div id="unanswered-container" class="bg-white p-6 rounded-xl shadow-md space-y-4">
                        <p class="text-gray-500">No unanswered questions found.</p>
                    </div>
                </div>

                <!-- Chats Section -->
                <div id="chats-section" class="admin-section hidden">
                    <h1 class="text-4xl font-bold text-gray-800 mb-6">Chat History</h1>
                    <div id="chat-history-container" class="bg-white p-6 rounded-xl shadow-md space-y-4">
                        <p class="text-gray-500">No chat history found.</p>
                    </div>
                </div>

                <!-- Magic Lab Section -->
                <div id="magic-lab-section" class="admin-section hidden">
                    <h1 class="text-4xl font-bold text-gray-800 mb-6">Magic Lab</h1>
                    <div class="bg-white p-8 rounded-xl shadow-md">
                        <h3 class="text-2xl font-bold mb-6">Train Your AI Model</h3>
                        
                        <!-- Training Form -->
                        <div class="mb-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="train-question" class="block text-lg font-medium text-gray-700 mb-2">Question</label>
                                    <textarea id="train-question" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label for="train-answer" class="block text-lg font-medium text-gray-700 mb-2">Answer</label>
                                    <textarea id="train-answer" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-4">
                                <button id="save-training-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors"><i class="fas fa-save mr-2"></i>Save to Firebase</button>
                                <button id="cancel-edit-btn" class="hidden bg-gray-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-600 transition-colors">Cancel Edit</button>
                            </div>
                        </div>

                        <div class="border-t pt-8">
                            <h3 class="text-2xl font-bold mb-4">Training Data</h3>
                             <div id="training-data-container" class="space-y-4 max-h-96 overflow-y-auto p-4 bg-gray-50 rounded-lg">
                                <!-- Training data will be loaded here -->
                             </div>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Code Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 h-5/6 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Code Preview</h2>
                <button id="close-preview-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <iframe id="preview-frame" class="w-full h-full border-0"></iframe>
        </div>
    </div>
    
    <!-- Mind Map Modal -->
    <div id="mindmap-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 h-5/6 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Conversation Mind Map</h2>
                <button id="close-mindmap-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <svg id="mindmap-svg" class="w-full h-full"></svg>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button id="close-settings-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="space-y-6">
                 <div class="flex items-center justify-between">
                    <label for="dark-mode-toggle" class="text-gray-700">Dark Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label for="always-listen-toggle" class="text-gray-700">Always Listen Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="always-listen-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label for="user-color-picker" class="text-gray-700">Your Bubble Color</label>
                    <input type="color" id="user-color-picker" value="#007bff">
                </div>
                 <div class="flex items-center justify-between">
                    <label for="ai-color-picker" class="text-gray-700">Aurix's Bubble Color</label>
                    <input type="color" id="ai-color-picker" value="#e9e9eb">
                </div>
                 <div class="flex items-center justify-between">
                    <label for="bg-color-picker" class="text-gray-700">Chat Background</label>
                    <input type="color" id="bg-color-picker" value="#ffffff">
                </div>
                 <div class="flex items-center justify-between">
                    <label for="font-size-slider" class="text-gray-700">Font Size</label>
                    <input type="range" id="font-size-slider" min="12" max="20" value="16" class="w-1/2">
                </div>
                 <div class="flex items-center justify-between">
                    <label for="language-select" class="text-gray-700">Language</label>
                    <select id="language-select" class="p-1 border rounded">
                        <option>English</option>
                        <option>Spanish</option>
                        <option>French</option>
                        <option>German</option>
                        <option>Arabic</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                 <button id="reset-settings-btn" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-600 transition-colors">Reset</button>
                 <button id="save-settings-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">Save</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDetf-322YgrrJzgUemO-lPg1IDsuTy4lI",
            authDomain: "speedai-1798b.firebaseapp.com",
            projectId: "speedai-1798b",
            storageBucket: "speedai-1798b.appspot.com",
            messagingSenderId: "60237083100",
            appId: "1:60237083100:web:d1f581a002485cea8b5f19",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
        
        window.db = db;
        window.auth = auth;
        window.firebase = { collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, orderBy, onAuthStateChanged };
    </script>
    
    <!-- App Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { db, auth, firebase } = window;
            const { collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, orderBy, onAuthStateChanged } = firebase;

            // --- Elements ---
            const loginModal = document.getElementById('login-modal');
            const adminPanel = document.getElementById('admin-panel');
            const userChatInterface = document.getElementById('user-chat-interface');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');
            const mainTitle = document.getElementById('main-title');
            
            // Chat elements
            const sendBtn = document.getElementById('send-btn');
            const userInput = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const filePreviewContent = document.getElementById('file-preview-content');
            const removeFileBtn = document.getElementById('remove-file-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const micBtn = document.getElementById('mic-btn');
            
            // Study Mode Elements
            const studyModeToggle = document.getElementById('study-mode-toggle');
            const studyModeControls = document.getElementById('study-mode-controls');
            const summarizeBtn = document.getElementById('summarize-btn');
            const testBtn = document.getElementById('test-btn');
            
            // Mind Map Elements
            const mindmapBtn = document.getElementById('mindmap-btn');
            const mindmapModal = document.getElementById('mindmap-modal');
            const closeMindmapModal = document.getElementById('close-mindmap-modal');
            const mindmapSvg = document.getElementById('mindmap-svg');

            // Admin Panel elements
            const adminNavLinks = document.querySelectorAll('.admin-nav-link');
            const adminSections = document.querySelectorAll('.admin-section');
            const trainedCountEl = document.getElementById('trained-count');
            const chatCountEl = document.getElementById('chat-count');
            const chatHistoryContainer = document.getElementById('chat-history-container');
            const unansweredContainer = document.getElementById('unanswered-container');
            const unansweredCountEl = document.getElementById('unanswered-count');

            // Magic Lab elements
            const saveTrainingBtn = document.getElementById('save-training-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const trainQuestion = document.getElementById('train-question');
            const trainAnswer = document.getElementById('train-answer');
            const trainingDataContainer = document.getElementById('training-data-container');
            
            // Modal elements
            const previewModal = document.getElementById('preview-modal');
            const closePreviewModalBtn = document.getElementById('close-preview-modal');
            const previewFrame = document.getElementById('preview-frame');
            const settingsModal = document.getElementById('settings-modal');
            const settingsBtn = document.getElementById('settings-btn');
            const closeSettingsModal = document.getElementById('close-settings-modal');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            const alwaysListenToggle = document.getElementById('always-listen-toggle');
            const userColorPicker = document.getElementById('user-color-picker');
            const aiColorPicker = document.getElementById('ai-color-picker');
            const bgColorPicker = document.getElementById('bg-color-picker');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const languageSelect = document.getElementById('language-select');

            // --- State ---
            let trainingData = [];
            let currentUserId = null;
            let editingItemId = null; 
            let codeSnippets = {}; // Store raw code for preview/copy
            let attachedFile = null; // Store attached file data
            let chatHistory = []; // For conversational memory
            let isStudyMode = false;
            let isRecording = false;
            let alwaysListen = false;
            let modelLanguage = 'English';
            const GEMINI_API_KEY = "AIzaSyDNuKkgJyS3Y6hgCySGJlDaejtEyav13yQ";
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            
            // --- Firebase Collections ---
            const trainingCollection = collection(db, "training_data");
            const chatsCollection = collection(db, "chats");
            const unansweredCollection = collection(db, "unanswered_questions");

            // --- Global Data Loading ---
            const loadGlobalTrainingData = () => {
                const q = query(trainingCollection);
                onSnapshot(q, (snapshot) => {
                    trainingData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }, (error) => {
                    console.error("Error loading training data:", error);
                });
            };
            loadGlobalTrainingData();


            // --- Authentication ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserId = user.uid;
                }
            });

            // --- Secret Admin Trigger ---
            let clickCount = 0;
            let clickTimer;
            mainTitle.addEventListener('click', () => {
                clickCount++;
                clearTimeout(clickTimer);
                clickTimer = setTimeout(() => { clickCount = 0; }, 1500);
                if (clickCount === 5) {
                    loginModal.classList.remove('hidden');
                    clickCount = 0;
                    clearTimeout(clickTimer);
                }
            });

            // --- Admin Authentication ---
            const adminCredentials = { username: "Mostafa", password: "123456789#Osama" };
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('username').value === adminCredentials.username && document.getElementById('password').value === adminCredentials.password) {
                    loginModal.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    userChatInterface.classList.add('hidden');
                    loginError.classList.add('hidden');
                    loadAdminData();
                } else {
                    loginError.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', () => {
                adminPanel.classList.add('hidden');
                userChatInterface.classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            });

            // --- Admin Panel Logic ---
            function loadAdminData() {
                loadAdminTrainingDataView();
                loadChatHistory();
                loadUnansweredQuestions();
            }

            adminNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    adminSections.forEach(section => section.classList.add('hidden'));
                    document.getElementById(targetId).classList.remove('hidden');
                    adminNavLinks.forEach(nav => nav.classList.remove('active', 'bg-white/20'));
                    link.classList.add('active', 'bg-white/20');
                });
            });

            // --- User Chat Logic ---
            const addMessageToChatUI = (content, sender) => {
                if (typeof content === 'string') {
                    const codeBlockRegex = /```(\w*)\n([\s\S]+?)```/g;
                    let lastIndex = 0;
                    let hasCode = false;

                    content.replace(codeBlockRegex, (match, language, code, offset) => {
                        hasCode = true;
                        const precedingText = content.substring(lastIndex, offset);
                        if (precedingText.trim()) {
                            const bubble = document.createElement('div');
                            bubble.classList.add('chat-bubble', 'chat-bubble-ai');
                            bubble.textContent = precedingText.trim();
                            chatBox.appendChild(bubble);
                        }

                        language = language || 'code';
                        code = code.trim();
                        
                        const codeContainer = document.createElement('div');
                        codeContainer.className = 'code-block';
                        
                        const codeId = `code-${Date.now()}-${Math.random()}`;
                        codeSnippets[codeId] = code;
                        const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                        codeContainer.innerHTML = `
                            <div class="code-header">
                                <span>${language}</span>
                                <div>
                                    <button class="preview-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded mr-2" data-code-id="${codeId}">Run Preview</button>
                                    <button class="copy-btn bg-gray-600 hover:bg-gray-700 text-white text-xs py-1 px-2 rounded" data-code-id="${codeId}">Copy Code</button>
                                </div>
                            </div>
                            <div class="code-body">
                                <pre><code>${escapedCode}</code></pre>
                            </div>
                        `;
                        chatBox.appendChild(codeContainer);
                        lastIndex = offset + match.length;
                    });

                    const remainingText = content.substring(lastIndex).trim();
                    if (!hasCode) {
                        const bubble = document.createElement('div');
                        bubble.classList.add('chat-bubble', sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai');
                        bubble.textContent = content;
                        chatBox.appendChild(bubble);
                    } else if (remainingText) {
                        const bubble = document.createElement('div');
                        bubble.classList.add('chat-bubble', 'chat-bubble-ai');
                        bubble.textContent = remainingText;
                        chatBox.appendChild(bubble);
                    }
                } else if (content instanceof HTMLElement) {
                    chatBox.appendChild(content);
                }

                chatBox.scrollTop = chatBox.scrollHeight;
            };

            const getAIResponse = async (history, question, file = null, studyTask = null) => {
                const lowerCaseQuestion = question.toLowerCase().trim();
                const found = trainingData.find(item => item.question.toLowerCase().trim() === lowerCaseQuestion);
                if (found) {
                    return found.answer;
                }

                if (!file && !studyTask) {
                     addMessageToChatUI('Aurix is searching the web...', 'ai');
                    try {
                        const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(question)}&format=json`);
                        const data = await response.json();
                        let webAnswer = "I couldn't find a direct answer on the web. My administrator has been notified.";
                        if(data.AbstractText) {
                            webAnswer = data.AbstractText;
                        }
                        await addDoc(trainingCollection, { question: question, answer: webAnswer });
                        return webAnswer;
                    } catch (error) {
                        console.error("Web search failed:", error);
                        await addDoc(unansweredCollection, { question: question, timestamp: serverTimestamp() });
                        return "I'm having trouble searching the web right now. My administrator has been notified.";
                    } finally {
                        const thinkingBubble = Array.from(chatBox.children).find(el => el.textContent.includes('searching'));
                        if (thinkingBubble) thinkingBubble.remove();
                    }
                }

                addMessageToChatUI('Aurix is thinking...', 'ai');
                
                let systemPrompt = `You are Aurix, a helpful and friendly assistant from the SpeedAI Company. Respond in ${modelLanguage}.`;
                
                const parts = [];
                if (file) {
                    parts.push(file.part);
                    if (studyTask === 'summarize') {
                        parts.push({text: "Please summarize the key points from the provided document."});
                        systemPrompt = `You are Aurix, an expert academic assistant. Summarize the provided text concisely in ${modelLanguage}.`;
                    } else if (studyTask === 'test') {
                        parts.push({text: "Generate a multiple-choice quiz with 3-4 questions based on the provided document. Provide the correct answer for each question."});
                         systemPrompt = `You are Aurix, an expert quiz creator. Create a multiple-choice quiz from the text in ${modelLanguage}.`;
                    } else {
                        parts.push({text: question || `Describe this ${file.type}`});
                    }
                } else {
                     if (studyTask === 'summarize') {
                        const conversationText = history.map(entry => entry.parts[0].text).join('\n');
                        parts.push({text: `Please summarize the key points from the following conversation:\n${conversationText}`});
                        systemPrompt = `You are Aurix, an expert academic assistant. Summarize the provided text concisely in ${modelLanguage}.`;
                    } else if (studyTask === 'test') {
                        const conversationText = history.map(entry => entry.parts[0].text).join('\n');
                        parts.push({text: `Generate a multiple-choice quiz with 3-4 questions based on the following conversation. Provide the correct answer for each question:\n${conversationText}`});
                         systemPrompt = `You are Aurix, an expert quiz creator. Create a multiple-choice quiz from the text in ${modelLanguage}.`;
                    } else {
                        parts.push({text: question});
                    }
                }

                const currentHistory = [...history, { role: "user", parts: parts }];
                
                try {
                    const geminiPayload = {
                        contents: currentHistory,
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const data = await callApiWithRetry(GEMINI_API_URL, geminiPayload, { 'Content-Type': 'application/json' });
                    const geminiAnswer = data.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "user", parts: parts });
                    chatHistory.push({ role: "model", parts: [{ text: geminiAnswer }] });

                    return geminiAnswer;

                } catch (error) {
                    console.error("Failed to get response from Gemini after multiple retries:", error);
                    return "I'm having a little trouble connecting to my brain right now. Please try again later.";
                } finally {
                     const thinkingBubble = Array.from(chatBox.children).find(el => el.textContent.includes('thinking'));
                    if (thinkingBubble) thinkingBubble.remove();
                }
            };

            const handleSendMessage = async (studyTask = null) => {
                const message = userInput.value.trim();
                if (!message && !attachedFile && !studyTask) return;
                if (!currentUserId) {
                    alert("Cannot send message. User not authenticated.");
                    return;
                }
                
                if(message) addMessageToChatUI(message, 'user');
                userInput.value = '';
                const fileToSend = attachedFile;
                resetFileInput();

                const aiResponse = await getAIResponse(chatHistory, message, fileToSend, studyTask);
                addMessageToChatUI(aiResponse, 'ai');

                await addDoc(chatsCollection, {
                    userId: currentUserId,
                    userMessage: message,
                    aiResponse: aiResponse,
                    hasFile: !!fileToSend,
                    timestamp: serverTimestamp()
                });
            };

            sendBtn.addEventListener('click', () => handleSendMessage());
            userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });

            // --- File Handling Logic ---
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileData = event.target.result;
                    let previewHtml = '';

                    if (file.type.startsWith('image/')) {
                        attachedFile = { part: { inlineData: { mimeType: file.type, data: fileData.split(',')[1] } }, type: 'image' };
                        previewHtml = `<img src="${fileData}" class="rounded-lg max-h-24" />`;
                    } else if (file.type === 'text/html') {
                        attachedFile = { part: { text: fileData }, type: 'html' };
                        previewHtml = `<i class="fas fa-file-code text-4xl text-gray-600"></i> <span class="text-sm">${file.name}</span>`;
                    } else if (file.type === 'application/pdf') {
                        attachedFile = { part: { text: `User uploaded a PDF file named ${file.name}. Inform the user that you can see the file type but cannot yet read its contents.` }, type: 'pdf' };
                        previewHtml = `<i class="fas fa-file-pdf text-4xl text-red-600"></i> <span class="text-sm">${file.name}</span>`;
                    }
                    
                    filePreviewContent.innerHTML = previewHtml;
                    filePreviewContainer.classList.remove('hidden');
                };

                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            });

            const resetFileInput = () => {
                attachedFile = null;
                fileInput.value = '';
                filePreviewContainer.classList.add('hidden');
                filePreviewContent.innerHTML = '';
            };

            removeFileBtn.addEventListener('click', resetFileInput);
            
            // --- Study Mode Logic ---
            studyModeToggle.addEventListener('click', () => {
                isStudyMode = !isStudyMode;
                studyModeControls.classList.toggle('hidden');
                studyModeToggle.classList.toggle('text-blue-600');
            });
            
            summarizeBtn.addEventListener('click', () => {
                if (!attachedFile && chatHistory.length === 0) {
                    alert("Please attach a file or have a conversation to summarize.");
                    return;
                }
                handleSendMessage('summarize');
            });

            testBtn.addEventListener('click', () => {
                if (!attachedFile && chatHistory.length === 0) {
                    alert("Please attach a file or have a conversation to create a test from.");
                    return;
                }
                handleSendMessage('test');
            });
            
            // --- Mind Map Logic ---
            mindmapBtn.addEventListener('click', async () => {
                if (chatHistory.length === 0) {
                    alert("Chat history is empty. Have a conversation first!");
                    return;
                }
                
                const conversationText = chatHistory.map(entry => `${entry.role}: ${entry.parts[0].text}`).join('\n');
                
                addMessageToChatUI("Generating mind map...", 'ai');

                const prompt = `Convert the following conversation into a hierarchical mind map using markdown format. The root node should be "Conversation Summary".\n\n${conversationText}`;
                
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }]})
                    });
                    if (!response.ok) throw new Error("API Error");
                    const data = await response.json();
                    const markdown = data.candidates[0].content.parts[0].text.replace(/```markdown\n|```/g, '').trim();

                    const { Markmap, transformer } = window.markmap;
                    const { root } = transformer.transform(markdown);
                    mindmapSvg.innerHTML = ''; // Clear previous map
                    Markmap.create(mindmapSvg, null, root);
                    mindmapModal.classList.remove('hidden');

                } catch(e) {
                    alert("Could not generate mind map.");
                } finally {
                     const thinkingBubble = Array.from(chatBox.children).find(el => el.textContent.includes('Generating mind map'));
                    if (thinkingBubble) thinkingBubble.remove();
                }
            });
            
            closeMindmapModal.addEventListener('click', () => {
                mindmapModal.classList.add('hidden');
                mindmapSvg.innerHTML = '';
            });

            // --- New Chat Logic ---
            newChatBtn.addEventListener('click', () => {
                chatHistory = [];
                chatBox.innerHTML = '';
                addMessageToChatUI("Hello! I am Aurix. Activate 'Study Mode' with the cap icon to create tests or summarize files.", 'ai');
                resetFileInput();
                if (isStudyMode) {
                    studyModeToggle.click();
                }
            });

            // --- Speech to Text Logic ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                micBtn.addEventListener('click', () => {
                    if (!isRecording) {
                        recognition.start();
                    } else {
                        recognition.stop();
                    }
                });

                recognition.onstart = () => {
                    isRecording = true;
                    micBtn.querySelector('i').classList.add('text-red-500');
                };

                recognition.onend = () => {
                    isRecording = false;
                    micBtn.querySelector('i').classList.remove('text-red-500');
                    if(alwaysListen) {
                        setTimeout(() => recognition.start(), 250);
                    }
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error);
                    isRecording = false;
                    micBtn.querySelector('i').classList.remove('text-red-500');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    userInput.value = finalTranscript + interimTranscript;
                    
                    if (finalTranscript.toLowerCase().includes('send')) {
                        userInput.value = finalTranscript.toLowerCase().replace('send', '').trim();
                        if(isRecording) recognition.stop();
                        sendBtn.click();
                    }
                };

            } else {
                micBtn.classList.add('hidden');
                console.log("Speech recognition not supported in this browser.");
            }

            // --- Settings Logic ---
            const applySettings = () => {
                const userColor = localStorage.getItem('aurixUserColor') || '#007bff';
                const aiColor = localStorage.getItem('aurixAiColor') || '#e9e9eb';
                const bgColor = localStorage.getItem('aurixBgColor') || '#ffffff';
                const fontSize = localStorage.getItem('aurixFontSize') || '16';
                const savedAlwaysListen = localStorage.getItem('aurixAlwaysListen') === 'true';
                const isDarkMode = localStorage.getItem('aurixDarkMode') === 'true';
                const savedLanguage = localStorage.getItem('aurixLanguage') || 'English';

                userColorPicker.value = userColor;
                aiColorPicker.value = aiColor;
                bgColorPicker.value = bgColor;
                fontSizeSlider.value = fontSize;
                alwaysListenToggle.checked = savedAlwaysListen;
                alwaysListen = savedAlwaysListen;
                darkModeToggle.checked = isDarkMode;
                languageSelect.value = savedLanguage;
                modelLanguage = savedLanguage;

                document.body.classList.toggle('dark-mode', isDarkMode);

                const styleId = 'dynamic-theme-style';
                let styleElement = document.getElementById(styleId);
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                styleElement.innerHTML = `
                    :root {
                        --bubble-user-bg: ${userColor};
                        --bubble-ai-bg: ${aiColor};
                    }
                    body:not(.dark-mode) {
                         --bg-chat-window: ${bgColor};
                    }
                    #chat-box { font-size: ${fontSize}px !important; }
                `;
            };

            settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettingsModal.addEventListener('click', () => settingsModal.classList.add('hidden'));
            
            saveSettingsBtn.addEventListener('click', () => {
                localStorage.setItem('aurixUserColor', userColorPicker.value);
                localStorage.setItem('aurixAiColor', aiColorPicker.value);
                localStorage.setItem('aurixBgColor', bgColorPicker.value);
                localStorage.setItem('aurixFontSize', fontSizeSlider.value);
                localStorage.setItem('aurixAlwaysListen', alwaysListenToggle.checked);
                localStorage.setItem('aurixDarkMode', darkModeToggle.checked);
                localStorage.setItem('aurixLanguage', languageSelect.value);
                applySettings();
                settingsModal.classList.add('hidden');
            });

            resetSettingsBtn.addEventListener('click', () => {
                localStorage.removeItem('aurixUserColor');
                localStorage.removeItem('aurixAiColor');
                localStorage.removeItem('aurixBgColor');
                localStorage.removeItem('aurixFontSize');
                localStorage.removeItem('aurixAlwaysListen');
                localStorage.removeItem('aurixDarkMode');
                localStorage.removeItem('aurixLanguage');
                applySettings();
            });

            applySettings();


            // --- Magic Lab & Admin View ---
            const resetTrainingForm = () => {
                editingItemId = null;
                trainQuestion.value = '';
                trainAnswer.value = '';
                saveTrainingBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save to Firebase';
                cancelEditBtn.classList.add('hidden');
            };

            const loadAdminTrainingDataView = () => {
                const q = query(trainingCollection, orderBy("question"));
                onSnapshot(q, (snapshot) => {
                    const adminTrainingData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    trainedCountEl.textContent = adminTrainingData.length;
                    
                    trainingDataContainer.innerHTML = '';
                    if (adminTrainingData.length === 0) {
                        trainingDataContainer.innerHTML = '<p class="text-gray-500">No training data found.</p>';
                        return;
                    }
                    adminTrainingData.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center gap-4';
                        div.innerHTML = `
                            <div class="flex-1">
                                <p class="font-bold text-gray-700">${item.question}</p>
                                <p class="text-gray-600 mt-1">${item.answer}</p>
                            </div>
                            <div class="flex">
                                <button data-id="${item.id}" class="edit-btn text-blue-500 hover:text-blue-700 transition-colors p-2"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${item.id}" class="delete-btn text-red-500 hover:text-red-700 transition-colors p-2"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        trainingDataContainer.appendChild(div);
                    });
                });
            };
            
            saveTrainingBtn.addEventListener('click', async () => {
                const question = trainQuestion.value.trim();
                const answer = trainAnswer.value.trim();

                if (!question || !answer) {
                    alert('Please provide both a question and an answer.');
                    return;
                }

                try {
                    if (editingItemId) {
                        const docRef = doc(db, "training_data", editingItemId);
                        await updateDoc(docRef, { question, answer });
                        alert('Entry updated successfully!');
                    } else {
                        await addDoc(trainingCollection, { question, answer });
                        alert('Training pair saved successfully!');
                    }
                    resetTrainingForm();
                } catch (error) {
                    console.error("Error saving document: ", error);
                    alert('Failed to save data.');
                }
            });

            cancelEditBtn.addEventListener('click', resetTrainingForm);

            trainingDataContainer.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const id = editBtn.getAttribute('data-id');
                    const itemToEdit = trainingData.find(item => item.id === id);
                    if (itemToEdit) {
                        editingItemId = id;
                        trainQuestion.value = itemToEdit.question;
                        trainAnswer.value = itemToEdit.answer;
                        saveTrainingBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Entry';
                        cancelEditBtn.classList.remove('hidden');
                        window.scrollTo(0, 0);
                    }
                }

                if (deleteBtn) {
                    const id = deleteBtn.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this training pair?')) {
                        try {
                            await deleteDoc(doc(db, "training_data", id));
                            alert('Deleted successfully.');
                            resetTrainingForm();
                        } catch (error) { 
                            console.error("Error deleting document: ", error);
                            alert('Failed to delete.');
                        }
                    }
                }
            });

            // --- Chat History Logic ---
            const loadChatHistory = () => {
                const q = query(chatsCollection, orderBy("timestamp", "desc"));
                onSnapshot(q, (snapshot) => {
                    chatCountEl.textContent = snapshot.size;
                    chatHistoryContainer.innerHTML = '';
                    if (snapshot.empty) {
                        chatHistoryContainer.innerHTML = '<p class="text-gray-500">No chat history found.</p>';
                        return;
                    }
                    snapshot.docs.forEach(doc => {
                        const chat = doc.data();
                        const date = chat.timestamp?.toDate().toLocaleString() || 'No date';
                        const div = document.createElement('div');
                        div.className = 'p-4 border rounded-lg hover:bg-gray-50';
                        div.innerHTML = `
                            <p class="text-sm text-gray-500"><strong>User:</strong> ${chat.userId.substring(0, 8)}... on ${date}</p>
                            <p class="mt-2"><strong>You:</strong> ${chat.hasFile ? '(File attached) ' : ''}${chat.userMessage}</p>
                            <p class="mt-1"><strong>Aurix:</strong> ${chat.aiResponse.substring(0, 100)}...</p>
                        `;
                        trainingDataContainer.appendChild(div);
                    });
                }, (error) => {
                    console.error("Error loading chat history:", error);
                    chatHistoryContainer.innerHTML = `<p class="text-red-500">Error loading chat history: ${error.message}. Check your Firestore security rules.</p>`;
                });
            };
            
            // --- Code Block Interaction & Modals ---
            chatBox.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-btn');
                const previewBtn = e.target.closest('.preview-btn');

                if (copyBtn) {
                    const codeId = copyBtn.dataset.codeId;
                    const textToCopy = codeSnippets[codeId];
                    
                    if (textToCopy) {
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = 'Copy Code'; }, 2000);
                    }
                }

                if (previewBtn) {
                    const codeId = previewBtn.dataset.codeId;
                    const codeToPreview = codeSnippets[codeId];
                    
                    if (codeToPreview) {
                        previewFrame.srcdoc = codeToPreview;
                        previewModal.classList.remove('hidden');
                    }
                }
            });

            closePreviewModalBtn.addEventListener('click', () => {
                previewModal.classList.add('hidden');
                previewFrame.srcdoc = ''; // Clear the frame
            });

        });
    </script>
</body>
</html>
